!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"==typeof exports?exports.StructuredChannel=t():e.StructuredChannel=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var s=n[r]={exports:{},id:r,loaded:!1};return e[r].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){"use strict";function n(e,t){this._handleMessage=this._handleMessage.bind(this),this._handlers=new Map,this._pendingMessages=new Map,this._messageID=0,this._doDebug=!1,this.port=e,this.port.addEventListener("message",this._handleMessage),this.port.start(),this.origin=t}var r="X-StructuredChannel-internal-reply",s="X-StructuredChannel-internal-hello",o="*";n.prototype={_debug:function(){if(this._doDebug){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];console.log.apply(console,["DEBUG:"].concat(t))}},_warn:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];console.warn.apply(console,["WARNING:"].concat(t))},on:function(e,t){if(this._handlers.has(e))throw new Error("Multiple handlers registered for "+e);this._handlers.set(e,t)},off:function(e){return this._handlers.has(e)?void this._handlers["delete"](e):void this._warn("WARNING: Tried to unregister handler for",e,"that has no handler.")},send:function(e,t){var n=this,r={id:this._messageID++,payload:t,type:e};return new Promise(function(e,t){n._pendingMessages.set(r.id,{resolve:e,reject:t}),n.port.postMessage(r)})},_handleMessage:function(e){var t=this;if(this.origin!==o&&this.origin!==e.origin)return void this._warn("Got a message from unexpected origin",e.origin);var n=e.data.data;this._debug("Got a message with data:",n);var s=n.id,i=n.type,a=n.payload;if(!s||!i||"string"!=typeof i||!i.trim())return void this._warn("Got an invalid message:",n);if(i===r){if(!this._pendingMessages.has(s))return void this._debug("Ignoring an unexpected reply.");var d=this._pendingMessages.get(s),h=d.resolve,u=d.reject;return n.error?(this._debug("Received an error reply for message",s),this._debug("Error was",n.error),u(n.error)):(this._debug("Received a success reply for message",s),this._debug("Result was",n.result),h(n.result)),void this._pendingMessages["delete"](s)}var l=this._handlers.get(i),g=null;try{l?g=Promise.resolve(l(a)):(this._warn("Received a message of type",i,"that has no handler."),g=Promise.reject("Unhandled message "+i))}catch(p){this._warn("Handler function failed:",p),g=Promise.reject(p)}g.then(function(e){t.port.postMessage({type:r,error:!1,result:e,id:s})},function(e){t.port.postMessage({type:r,error:e,id:s})})}},n.connectTo=function(e,t,r){"function"==typeof t.MessageChannel&&(r=t,t=void 0);var i=r?new r.MessageChannel:new MessageChannel;if(e instanceof Window){var a=t?t:o;e.postMessage(s,a,[i.port2])}else e.postMessage(s,[i.port2]);return new n(i.port1,origin)},n.waitForConnection=function(e,t){return new Promise(function(e,r){var o=function(r){r.data===s&&(t.onmessage=null,e(new n(r.ports[0])))};t.onmessage=o})},e.exports=n}])});