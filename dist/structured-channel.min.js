!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"==typeof exports?exports.StructuredChannel=t():e.StructuredChannel=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var s=n[r]={exports:{},id:r,loaded:!1};return e[r].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){"use strict";function n(e,t){this._handleMessage=this._handleMessage.bind(this),this._handlers=new Map,this._pendingMessages=new Map,this._messageID=0,this._doDebug=!1,this.port=e,this.port.addEventListener("message",this._handleMessage),this.port.start(),this.origin=t}var r="X-StructuredChannel-internal-reply",s="X-StructuredChannel-internal-hello",o="*";n.prototype={_debug:function(){if(this._doDebug){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];console.log.apply(console,["DEBUG:"].concat(t))}},_warn:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];console.log("WARNING:",[].concat(t).map(JSON.stringify).join(" "))},on:function(e,t){if(this._handlers.has(e))throw new Error("Multiple handlers registered for "+e);this._handlers.set(e,t)},off:function(e){return this._handlers.has(e)?void this._handlers["delete"](e):void this._warn("WARNING: Tried to unregister handler for",e,"that has no handler.")},send:function(e,t){var n=this,r={id:this._messageID++,payload:t,type:e};return new Promise(function(e,t){n._pendingMessages.set(r.id,{resolve:e,reject:t}),n.port.postMessage(r)})},_handleMessage:function(e){var t=e.data;this._debug("Got a message with data:",t);var n=t.id,s=t.type;return void 0!==n&&s&&"string"==typeof s&&s.trim()?s===r?this._handleReply(t):this._handleNewMessage(t):void this._warn("Got an invalid message:",t)},_handleReply:function(e){var t=e.id;if(!this._pendingMessages.has(t))return void this._debug("Ignoring an unexpected reply.");var n=this._pendingMessages.get(t),r=n.resolve,s=n.reject;e.error?(this._debug("Received an error reply for message",t),this._debug("Error was",e.error),s(e.error)):(this._debug("Received a success reply for message",t),this._debug("Result was",e.result),r(e.result)),this._pendingMessages["delete"](t)},_handleNewMessage:function(e){var t=this,n=e.id,s=e.type,o=e.payload,a=this._handlers.get(s),i=null;try{a?i=Promise.resolve(a(o)):(this._warn("Received a message of type",s,"that has no handler."),i=Promise.reject("Unhandled message "+s))}catch(d){this._warn("Handler function failed:",d),i=Promise.reject(d.message||d.name||"Unknown error")}i.then(function(e){t.port.postMessage({type:r,result:e,id:n})},function(e){t.port.postMessage({type:r,error:e||"Unknown error",id:n})})["catch"](function(e){t.port.postMessage({type:r,error:"Reply failed",id:n})})}},n.connectTo=function(e,t,r){if(!e)return Promise.reject("Target must be defined.");t&&"function"==typeof t.MessageChannel&&(r=t,t=void 0);var a=r?new r.MessageChannel:new MessageChannel,i=t?t:o;if("document"in e){if(t&&t!==o&&t!==e.document.location.origin)return Promise.reject("The origins don't match.");e.postMessage(s,i,[a.port2])}else e.postMessage(s,[a.port2]);return new Promise(function(e,t){var r=new n(r.port1,i),s=function a(){r.off("ready",a),r.off("error",o),e(r)},o=function d(e){r.off("ready",success),r.off("error",d),t(e)};r.on("ready",s),r.on("error",o)})},n.waitForConnection=function(e,t){return new Promise(function(e,r){var o=function(r){if(r.data===s){t.onmessage=null;var o=new n(r.ports[0]);o.send("ready"),e(o)}};t.onmessage=o})},e.exports=n}])});