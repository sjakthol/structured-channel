!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"==typeof exports?exports.StructuredChannel=t():e.StructuredChannel=t()}(this,function(){return function(e){function t(s){if(n[s])return n[s].exports;var r=n[s]={exports:{},id:s,loaded:!1};return e[s].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){"use strict";function n(e,t){this._handleMessage=this._handleMessage.bind(this),this._handlers=new Map,this._pendingMessages=new Map,this._messageID=0,this._doDebug=!1,this.port=e,this.port.addEventListener("message",this._handleMessage),this.port.start(),this.origin=t}var s="X-StructuredChannel-internal-reply",r="X-StructuredChannel-internal-hello",o="*";n.prototype={_debug:function(){if(this._doDebug){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];console.log.apply(console,["DEBUG:"].concat(t))}},_warn:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];console.log("WARNING:",[].concat(t).map(JSON.stringify).join(" "))},on:function(e,t){if(this._handlers.has(e))throw new Error("Multiple handlers registered for "+e);this._handlers.set(e,t)},off:function(e){return this._handlers.has(e)?void this._handlers["delete"](e):void this._warn("WARNING: Tried to unregister handler for",e,"that has no handler.")},send:function(e,t){var n=this,s={id:this._messageID++,payload:t,type:e};return new Promise(function(e,t){n._pendingMessages.set(s.id,{resolve:e,reject:t}),n.port.postMessage(s)})},_handleMessage:function(e){var t=this,n=e.data;this._debug("Got a message with data:",n);var r=n.id,o=n.type,a=n.payload;if(void 0===r||!o||"string"!=typeof o||!o.trim())return void this._warn("Got an invalid message:",n);if(o===s){if(!this._pendingMessages.has(r))return void this._debug("Ignoring an unexpected reply.");var i=this._pendingMessages.get(r),d=i.resolve,h=i.reject;return n.error?(this._debug("Received an error reply for message",r),this._debug("Error was",n.error),h(n.error)):(this._debug("Received a success reply for message",r),this._debug("Result was",n.result),d(n.result)),void this._pendingMessages["delete"](r)}var u=this._handlers.get(o),l=null;try{u?l=Promise.resolve(u(a)):(this._warn("Received a message of type",o,"that has no handler."),l=Promise.reject("Unhandled message "+o))}catch(g){this._warn("Handler function failed:",g),l=Promise.reject(g)}l.then(function(e){t.port.postMessage({type:s,error:!1,result:e,id:r})},function(e){t.port.postMessage({type:s,error:e,id:r})})}},n.connectTo=function(e,t,s){t instanceof Object&&t.MessageChannel instanceof Function&&(s=t,t=void 0);var a=s?new s.MessageChannel:new MessageChannel,i=t?t:o;return e instanceof e.Window?e.postMessage(r,i,[a.port2]):e.postMessage(r,[a.port2]),new n(a.port1,i)},n.waitForConnection=function(e,t){return new Promise(function(e,s){var o=function(s){if(s.data===r){t.onmessage=null;var o=new n(s.ports[0]);o.send("ready"),e(o)}};t.onmessage=o})},e.exports=n}])});