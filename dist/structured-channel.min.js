!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"==typeof exports?exports.StructuredChannel=t():e.StructuredChannel=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var s=n[r]={exports:{},id:r,loaded:!1};return e[r].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){"use strict";function n(e,t){this._handleMessage=this._handleMessage.bind(this),this._handlers=new Map,this._pendingMessages=new Map,this._messageID=0,this._doDebug=!1,this.port=e,this.port.addEventListener("message",this._handleMessage),this.port.start(),this.origin=t}var r="X-StructuredChannel-internal-reply",s="X-StructuredChannel-internal-hello",o="*";n.prototype={_debug:function(){if(this._doDebug){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];console.log.apply(console,["DEBUG:"].concat(t))}},_warn:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];console.log("WARNING:",[].concat(t).map(JSON.stringify).join(" "))},on:function(e,t){if(this._handlers.has(e))throw new Error("Multiple handlers registered for "+e);this._handlers.set(e,t)},off:function(e){return this._handlers.has(e)?void this._handlers["delete"](e):void this._warn("WARNING: Tried to unregister handler for",e,"that has no handler.")},send:function(e,t){var n=this,r={id:this._messageID++,payload:t,type:e};return new Promise(function(e,t){n._pendingMessages.set(r.id,{resolve:e,reject:t}),n.port.postMessage(r)})},_handleMessage:function(e){var t=this,n=e.data;this._debug("Got a message with data:",n);var s=n.id,o=n.type,i=n.payload;if(void 0===s||!o||"string"!=typeof o||!o.trim())return void this._warn("Got an invalid message:",n);if(o===r){if(!this._pendingMessages.has(s))return void this._debug("Ignoring an unexpected reply.");var a=this._pendingMessages.get(s),d=a.resolve,h=a.reject;return n.error?(this._debug("Received an error reply for message",s),this._debug("Error was",n.error),h(n.error)):(this._debug("Received a success reply for message",s),this._debug("Result was",n.result),d(n.result)),void this._pendingMessages["delete"](s)}var u=this._handlers.get(o),l=null;try{u?l=Promise.resolve(u(i)):(this._warn("Received a message of type",o,"that has no handler."),l=Promise.reject("Unhandled message "+o))}catch(g){this._warn("Handler function failed:",g),l=Promise.reject(g)}l.then(function(e){t.port.postMessage({type:r,error:!1,result:e,id:s})},function(e){t.port.postMessage({type:r,error:e,id:s})})}},n.connectTo=function(e,t,r){if(!e)throw new TypeError("Target must be defined.");t&&"function"==typeof t.MessageChannel&&(r=t,t=void 0);var i=r?new r.MessageChannel:new MessageChannel,a=t?t:o;if("document"in e){if(t&&t!==o&&t===e.document.location.origin)throw new Error("The given origin does not match the target origin.");e.postMessage(s,a,[i.port2])}else e.postMessage(s,[i.port2]);return new n(i.port1,a)},n.waitForConnection=function(e,t){return new Promise(function(e,r){var o=function(r){if(r.data===s){t.onmessage=null;var o=new n(r.ports[0]);o.send("ready"),e(o)}};t.onmessage=o})},e.exports=n}])});