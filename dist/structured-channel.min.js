!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):"object"==typeof exports?exports.StructuredChannel=n():e.StructuredChannel=n()}(this,function(){return function(e){function n(r){if(t[r])return t[r].exports;var s=t[r]={exports:{},id:r,loaded:!1};return e[r].call(s.exports,s,s.exports,n),s.loaded=!0,s.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n){"use strict";function t(e,n){this._handleMessage=this._handleMessage.bind(this),this._handlers=new Map,this._pendingMessages=new Map,this._messageID=0,this._doDebug=!1,this.port=e,this.port.addEventListener("message",this._handleMessage),this.port.start(),this.origin=n}var r="X-StructuredChannel-internal-reply",s="X-StructuredChannel-internal-hello",o="*";t.prototype={_debug:function(){if(this._doDebug){for(var e=arguments.length,n=Array(e),t=0;e>t;t++)n[t]=arguments[t];console.log.apply(console,["DEBUG:"].concat(n))}},_warn:function(){for(var e=arguments.length,n=Array(e),t=0;e>t;t++)n[t]=arguments[t];console.log("WARNING:",[].concat(n).map(JSON.stringify).join(" "))},on:function(e,n){if(this._handlers.has(e))throw new Error("Multiple handlers registered for "+e);this._handlers.set(e,n)},off:function(e){return this._handlers.has(e)?void this._handlers["delete"](e):void this._warn("WARNING: Tried to unregister handler for",e,"that has no handler.")},send:function(e,n){var t=this,r={id:this._messageID++,payload:n,type:e};return new Promise(function(e,n){t._pendingMessages.set(r.id,{resolve:e,reject:n}),t.port.postMessage(r)})},_handleMessage:function(e){var n=e.data;this._debug("Got a message with data:",n);var t=n.id,s=n.type;return void 0!==t&&s&&"string"==typeof s&&s.trim()?s===r?this._handleReply(n):this._handleNewMessage(n):void this._warn("Got an invalid message:",n)},_handleReply:function(e){var n=e.id;if(!this._pendingMessages.has(n))return void this._debug("Ignoring an unexpected reply.");var t=this._pendingMessages.get(n),r=t.resolve,s=t.reject;e.error?(this._debug("Received an error reply for message",n),this._debug("Error was",e.error),s(e.error)):(this._debug("Received a success reply for message",n),this._debug("Result was",e.result),r(e.result)),this._pendingMessages["delete"](n)},_handleNewMessage:function(e){var n=this,t=e.id,s=e.type,o=e.payload,i=this._handlers.get(s),a=null;try{i?a=Promise.resolve(i(o)):(this._warn("Received a message of type",s,"that has no handler."),a=Promise.reject("Unhandled message "+s))}catch(d){this._warn("Handler function failed:",d),a=Promise.reject(d.message||d.name||"Unknown error")}a.then(function(e){n.port.postMessage({type:r,result:e,id:t})},function(e){n.port.postMessage({type:r,error:e||"Unknown error",id:t})})["catch"](function(e){n.port.postMessage({type:r,error:"Reply failed",id:t})})}},t.connectTo=function(e,n,r){if(!e)return Promise.reject("Target must be defined.");n&&"function"==typeof n.MessageChannel&&(r=n,n=void 0);var i=r?new r.MessageChannel:new MessageChannel,a=n?n:o;if("document"in e){if(n&&n!==o&&n!==e.document.location.origin)return Promise.reject("The origins don't match.");e.postMessage(s,a,[i.port2])}else e.postMessage(s,[i.port2]);return new Promise(function(e,n){var r=new t(i.port1,a),s=function d(){r.off("ready",d),r.off("error",o),e(r)},o=function h(e){r.off("ready",s),r.off("error",h),n(e)};r.on("ready",s),r.on("error",o)})},t.waitForConnection=function(e,n){return void 0===e&&(e=self),new Promise(function(r,i){var a=function(i){if(i.data===s){var a=new t(i.ports[0]);if(n&&n!==o&&n!==i.origin)return a.send("error","Disallowed origin.");e.onmessage=null,a.send("ready"),r(a)}};e.onmessage=a})},e.exports=t}])});